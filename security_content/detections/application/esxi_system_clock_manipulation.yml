name: ESXi System Clock Manipulation
id: 910df401-b215-4675-88c5-2ad7b06d82a5
version: 1
date: '2025-05-19'
author: Raven Tait, Splunk
status: production
type: TTP
description: This detection identifies a significant change to the system clock 
  on an ESXi host, which may indicate an attempt to manipulate timestamps and 
  evade detection or forensic analysis
data_source:
- VMWare ESXi Syslog
search: '`esxi_syslog` Message="*NTPClock*" AND Message="*system clock stepped*"
  | rex field=_raw "stepped to (?<epoch_time>\d+\.\d+),.+delta\s(?<delta>\d+)\s"
  | rex field=_raw "Z (?<dest>[\w\.]+)\s"
  | eval epoch_time=tonumber(epoch_time)
  | eval delta=tonumber(delta)
  | eval event_time=round(_time, 0)
  | eval direction=if(epoch_time < event_time, "backward", "forward")
  | eval original_time=if(direction=="backward", epoch_time + delta, epoch_time - delta)
  | eval stepped_to_str=strftime(epoch_time, "%Y-%m-%d %H:%M:%S")
  | eval original_time_str=strftime(original_time, "%Y-%m-%d %H:%M:%S")
  | stats min(_time) as firstTime max(_time) as lastTime count by dest direction original_time_str stepped_to_str epoch_time delta
  | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`
  | `esxi_system_clock_manipulation_filter`'
how_to_implement: This is based on syslog data generated by VMware ESXi hosts. To implement this search, 
  you must configure your ESXi systems to forward syslog output to your Splunk deployment. These logs must 
  be ingested with the appropriate Splunk Technology Add-on for VMware ESXi Logs, which provides field
  extractions and CIM compatibility. 
known_false_positives: Limited false positives in most environments, however tune
  as needed
drilldown_searches:
- name: View the detection results for - "$dest$"
  search: '%original_detection_search% | search  dest = "$dest$"'
  earliest_offset: $info_min_time$
  latest_offset: $info_max_time$
- name: View risk events for the last 7 days for - "$dest$"
  search: '| from datamodel Risk.All_Risk | search normalized_risk_object IN ("$dest$")
    starthoursago=168  | stats count min(_time) as firstTime max(_time) as lastTime
    values(search_name) as "Search Name" values(risk_message) as "Risk Message" values(analyticstories)
    as "Analytic Stories" values(annotations._all) as "Annotations" values(annotations.mitre_attack.mitre_tactic)
    as "ATT&CK Tactics" by normalized_risk_object | `security_content_ctime(firstTime)`
    | `security_content_ctime(lastTime)`'
  earliest_offset: $info_min_time$
  latest_offset: $info_max_time$
rba:
  message: Large time change on ESXi host $dest$.
  risk_objects:
  - field: dest
    type: system
    score: 50
  threat_objects: []
tags:
  analytic_story:
  - ESXi Post Compromise
  - Black Basta Ransomware
  asset_type: Infrastructure
  mitre_attack_id:
  - T1070.006
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1070/esxi_system_clock_manipulation/esxi_system_clock_manipulation.log
    source: vmware:esxlog
    sourcetype: vmw-syslog