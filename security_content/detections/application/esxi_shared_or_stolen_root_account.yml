name: ESXi Shared or Stolen Root Account
id: 1bc8f235-5d7c-457c-95ca-5e92edcb52ea
version: 1
date: '2025-05-09'
author: Raven Tait, Splunk
status: production
type: Anomaly
description: This detection monitors for signs of a shared or potentially compromised root account on ESXi
  hosts by tracking the number of unique IP addresses logging in as root within a short time window.
  Multiple logins from different IPs in a brief period may indicate credential misuse, 
  lateral movement, or account compromise.
data_source:
- VMWare ESXi Syslog
search: '`esxi_syslog` Message="*root*" Message="*logged in*" NOT Message="*root@127.0.0.1*"
  | rex field=_raw "root@(?<SrcIpAddr>\d{1,3}(?:\.\d{1,3}){3})"
  | rex field=_raw "Z (?<dest>[\w\.]+)\s"
  | bin _time span=15m
  | stats min(_time) as firstTime max(_time) as lastTime dc(SrcIpAddr) AS distinct_ip_count values(SrcIpAddr) AS SrcIps by dest
  | where distinct_ip_count > 1
  | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`
  | `esxi_shared_or_stolen_root_account_filter`'
how_to_implement: This is based on syslog data generated by VMware ESXi hosts. To implement this search, 
  you must configure your ESXi systems to forward logs to your Splunk deployment. These logs must 
  be ingested with the appropriate Splunk Technology Add-on for VMware ESXi Logs, which provides field
  extractions and CIM compatibility. 
known_false_positives: Limited false positives in most environments, however tune
  as needed
references:
- https://detect.fyi/detecting-and-responding-to-esxi-compromise-with-splunk-f33998ce7823
drilldown_searches:
- name: View the detection results for - "$dest$"
  search: '%original_detection_search% | search  dest = "$dest$"'
  earliest_offset: $info_min_time$
  latest_offset: $info_max_time$
- name: View risk events for the last 7 days for - "$dest$"
  search: '| from datamodel Risk.All_Risk | search normalized_risk_object IN ("$dest$")
    starthoursago=168  | stats count min(_time) as firstTime max(_time) as lastTime
    values(search_name) as "Search Name" values(risk_message) as "Risk Message" values(analyticstories)
    as "Analytic Stories" values(annotations._all) as "Annotations" values(annotations.mitre_attack.mitre_tactic)
    as "ATT&CK Tactics" by normalized_risk_object | `security_content_ctime(firstTime)`
    | `security_content_ctime(lastTime)`'
  earliest_offset: $info_min_time$
  latest_offset: $info_max_time$
rba:
  message: Root login from multiple IPs on ESXi host $dest$.
  risk_objects:
  - field: dest
    type: system
    score: 50
  threat_objects: []
tags:
  analytic_story:
  - ESXi Post Compromise
  - Black Basta Ransomware
  asset_type: Infrastructure
  mitre_attack_id:
  - T1078
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1078/esxi_stolen_root_account/esxi_stolen_root_account.log
    source: vmware:esxlog
    sourcetype: vmw-syslog
