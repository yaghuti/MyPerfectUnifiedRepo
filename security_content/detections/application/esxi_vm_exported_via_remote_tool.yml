name: ESXi VM Exported via Remote Tool
id: 2e155547-aaac-49d3-b0ef-ceabc31fd364
version: 1
date: '2025-05-15'
author: Raven Tait, Splunk
status: production
type: TTP
description: This detection identifies the use of a remote tool to download virtual machine disk 
  files from a datastore. The NFC protocol is used by management tools to transfer files 
  to and from ESXi hosts, but it can also be abused by attackers or insiders to exfiltrate 
  full virtual disk images
data_source:
- VMWare ESXi Syslog
search: '`esxi_syslog` Message="*File download from path*" Message="*was initiated from*"
  | rex field=_raw "from path ''\[(?<Datastore>[^\]]+)\](?<VMPath>[^'']+)''" 
  | rex field=_raw "initiated from ''(?<InitiatorTool>[^/]+)/(?<ToolVersion>[^@]+)@(?<InitiatorIP>\d{1,3}(?:\.\d{1,3}){3})''"
  | rex field=_raw "Z (?<dest>[\w\.]+)\s"
  | stats min(_time) as firstTime max(_time) as lastTime count by Datastore VMPath InitiatorTool ToolVersion InitiatorIP dest
  | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`
  | `esxi_vm_exported_via_remote_tool_filter`'  
how_to_implement: This is based on syslog data generated by VMware ESXi hosts. To implement this search, 
  you must configure your ESXi systems to forward syslog output to your Splunk deployment. These logs must 
  be ingested with the appropriate Splunk Technology Add-on for VMware ESXi Logs, which provides field
  extractions and CIM compatibility. 
known_false_positives: Administrators may use this command when troubleshooting. Tune as needed.
drilldown_searches:
- name: View the detection results for - "$dest$"
  search: '%original_detection_search% | search  dest = "$dest$"'
  earliest_offset: $info_min_time$
  latest_offset: $info_max_time$
- name: View risk events for the last 7 days for - "$dest$"
  search: '| from datamodel Risk.All_Risk | search normalized_risk_object IN ("$dest$")
    starthoursago=168  | stats count min(_time) as firstTime max(_time) as lastTime
    values(search_name) as "Search Name" values(risk_message) as "Risk Message" values(analyticstories)
    as "Analytic Stories" values(annotations._all) as "Annotations" values(annotations.mitre_attack.mitre_tactic)
    as "ATT&CK Tactics" by normalized_risk_object | `security_content_ctime(firstTime)`
    | `security_content_ctime(lastTime)`'
  earliest_offset: $info_min_time$
  latest_offset: $info_max_time$
rba:
  message: VM downloaded from datastore on ESXi host $dest$.
  risk_objects:
  - field: dest
    type: system
    score: 50
  threat_objects: []
tags:
  analytic_story:
  - ESXi Post Compromise
  - Black Basta Ransomware
  asset_type: Infrastructure
  mitre_attack_id:
  - T1005
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1005/esxi_vm_download/esxi_vm_download.log
    source: vmware:esxlog
    sourcetype: vmw-syslog