name: ESXi External Root Login Activity
id: 218bf991-6c63-4c26-a682-6ac1a53ad8f8
version: 1
date: '2025-05-13'
author: Raven Tait, Splunk
status: production
type: Anomaly
description: This detection identifies instances where the ESXi UI is accessed using the root
  account instead of a delegated administrative user. Direct root access to the UI bypasses 
  role-based access controls and auditing practices, and may indicate risky behavior, 
  misconfiguration, or unauthorized activity by a malicious actor using compromised credentials.
data_source:
- VMWare ESXi Syslog
search: '`esxi_syslog` Message="*root*" AND Message="*logged in*"
  | rex field=_raw "root@(?<SrcIpAddr>\d{1,3}(?:\.\d{1,3}){3})"
  | rex field=_raw "Z (?<dest>[\w\.]+)\s"
  | search SrcIpAddr != "127.0.0.1" AND SrcIpAddr != 192.168.0.0/16 AND SrcIpAddr != 172.16.0.0/12 AND SrcIpAddr != 10.0.0.0/8
  | stats min(_time) as firstTime max(_time) as lastTime count by dest SrcIpAddr 
  | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)`
  | `esxi_external_root_login_activity_filter`'
how_to_implement: This is based on syslog data generated by VMware ESXi hosts. To implement this search, 
  you must configure your ESXi systems to forward syslog output to your Splunk deployment. These logs must 
  be ingested with the appropriate Splunk Technology Add-on for VMware ESXi Logs, which provides field
  extractions and CIM compatibility. 
known_false_positives: Limited false positives in most environments, however tune
  as needed. Administrators may use the root account for troubleshooting or initial user creation.
drilldown_searches:
- name: View the detection results for - "$dest$"
  search: '%original_detection_search% | search  dest = "$dest$"'
  earliest_offset: $info_min_time$
  latest_offset: $info_max_time$
- name: View risk events for the last 7 days for - "$dest$"
  search: '| from datamodel Risk.All_Risk | search normalized_risk_object IN ("$dest$")
    starthoursago=168  | stats count min(_time) as firstTime max(_time) as lastTime
    values(search_name) as "Search Name" values(risk_message) as "Risk Message" values(analyticstories)
    as "Analytic Stories" values(annotations._all) as "Annotations" values(annotations.mitre_attack.mitre_tactic)
    as "ATT&CK Tactics" by normalized_risk_object | `security_content_ctime(firstTime)`
    | `security_content_ctime(lastTime)`'
  earliest_offset: $info_min_time$
  latest_offset: $info_max_time$
rba:
  message: Root logged in on ESXi host $dest$ from $SrcIpAddr.
  risk_objects:
  - field: dest
    type: system
    score: 45
  - field: SrcIpAddr
    type: system
    score: 45
  threat_objects: []
tags:
  analytic_story:
  - ESXi Post Compromise
  - Black Basta Ransomware
  asset_type: Infrastructure
  mitre_attack_id:
  - T1078
  product:
  - Splunk Enterprise
  - Splunk Enterprise Security
  - Splunk Cloud
  security_domain: endpoint
tests:
- name: True Positive Test
  attack_data:
  - data: https://media.githubusercontent.com/media/splunk/attack_data/master/datasets/attack_techniques/T1078/esxi_external_root_login/esxi_external_root_login.log
    source: vmware:esxlog
    sourcetype: vmw-syslog